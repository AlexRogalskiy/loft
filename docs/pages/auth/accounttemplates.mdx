---
title: Account Templates
sidebar_label: Account Templates
---

import Tabs from '@theme/Tabs'
import TabItem from '@theme/TabItem'

## What are Account Templates?

Cluster Account Templates are a way to automatically create kubernetes resources (especially accounts) in clusters for users or teams,
based on the template configuration. Since cluster access is determined in loft by who has an account in which cluster, creating
an account in a cluster leads automatically to cluster access. The templates can be also automatically applied for new users when using [Single Sign On](./oidc.mdx).

A cluster access template is a custom kubernetes resource in loft and consists of several parts:
1. **Selected Clusters**: A cluster selector, which selects the clusters by labels that the template should be applied for.
2. **Account Template**: An account template, that specifies how the created account should look like.
3. **Account Resources**: An array of owned resources (e.g. AccountQuota, ClusterRoleBinding etc.), which the account owns and an owner reference to the account is set. This has the
advantage that if the account is deleted, all of his owned resources are deleted as well and ownership of resources can be easily identified.

An example cluster account template could look like this:
```yaml
apiVersion: storage.loft.sh/v1
kind: ClusterAccountTemplate
metadata:
  name: my-cluster-account-template
  labels:
    # If this label is set on the account template,
    # it will be automatically preselected in the UI under
    # cluster access templates if a new user is created.
    loft.sh/default-template: "true"
spec:
  # This specifies for which clusters the resources should
  # be created. An empty cluster selector selects all clusters.
  clusterSelector: {}
  # The account template that specifies the kiosk account
  # settings. For each selected cluster a new account based
  # on this template is created. The account name is usually
  # the same as the kubernetes name of the user, except the
  # name already exists, then the account name will be generated.
  accountTemplate:
    spec:
      space:
        clusterRole: loft-cluster-space-default
  # Owned resources that will be created besides the account.
  # These are normal kubernetes resources with 3 distinct differences:
  # 1. You don't need a name or metadata for the resource (you can set it however), because
  #    loft will automatically set the metadata.generateName field to "AccountName-"
  # 2. You can reference the created account name with the placeholder ${LOFT_ACCOUNT_NAME}.
  #    This will be replaced before deploying the resource with the name of the just created
  #    account.
  # 3. An owner reference will be set automatically to the created resource that references
  #    the created account. This has the benefit that all owned resources will be cleaned up
  #    by kubernetes automatically if the account is deleted. For ClusterRoleBindings this
  #    also means that kiosk is able to automatically update and sync the subjects field.
  owns:
   - apiVersion: config.kiosk.sh/v1alpha1
     kind: AccountQuota
     # No metadata needed, generateName will be set automatically
     spec:
       account: '${LOFT_ACCOUNT_NAME}'
       quota:
         hard:
           limits.cpu: '8'
           limits.memory: '16Gi'
           requests.cpu: '2'
           requests.memory: '4Gi'
    - apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRoleBinding
      # No subjects needed, kiosk automatically syncs those based on the ownerReference
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: ClusterRole
        name: cluster-admin
```

## Create Cluster Account Templates

You can create cluster account templates either via kubectl or the loft UI.

<Tabs
  groupId="ui-cli-kubectl"
  defaultValue="ui"
  values={[
    { label: 'UI', value: 'ui', },
    { label: 'kubectl', value: 'kubectl', },
  ]
}>
<TabItem value="ui">

Navigate to the Account Templates section under `Users` and press `Add Cluster Account Template`.

<figure class="frame">
  <img src="/docs/media/ui/auth/cat-create-01.png" alt="Create a new Cluster Account Template" />
  <figcaption>Create a new Cluster Account Template</figcaption>
</figure>

You will be presented with several options how the Cluster Account Template can be configured:

<figure class="frame">
  <img src="/docs/media/ui/auth/cat-create-02.png" alt="Create a new Cluster Account Template" />
  <figcaption>Create a new Cluster Account Template</figcaption>
</figure>

- **Metadata of Cluster Account Template**: The metadata such as name, labels and annotations of the created cluster account template.
- **1. Select Clusters**: Labels in the form of `label1=value1` that specify in which clusters an account should be created in. If empty, all clusters are selected. You will see which clusters are selected in the account templates table under the column 'Selected Clusters'
- **2. Create Account in Clusters**: Account settings for the account that will be created in the cluster. This section is very similar to the `Space Creation Settings` section in the `Clusters -> Accounts` drawer.
- **3. Create Account Resources in Clusters**:
  - **Account Quota**: Here you can define the hard limits for an account quota that will be created for the account. Leave empty to create no AccountQuota for the account.
  - **Cluster Role Bindings**: For each of these cluster roles, a [ClusterRoleBinding](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#rolebinding-and-clusterrolebinding) is created for the account. Use this for example if you want to grant a user full cluster access.
  - **Other Resources**: Other custom kubernetes resources that should be created in the target cluster for the account. This can be any kubernetes resource yaml. Bear in mind that:
    - No metadata section required: loft will automatically set metadata.generateName if no metadata for a resource is provided
    - You can use ${LOFT_ACCOUNT_NAME} as a placeholder for the account name. For example, in an AccountQuota you can set `spec.account: ${LOFT_ACCOUNT_NAME}`. This will be replaced when the account is actually created with the correct account name.
    - An ownerReference will be set automatically for the resource that references the account. This means that deleting the account will also delete all his resources.

After you are done configuring the ClusterAccountTemplate, press `Create` to create the resource. This will not create any accounts yet.

</TabItem>
<TabItem value="kubectl">

Create file `clusteraccounttemplate.yaml`:
```yaml
apiVersion: storage.loft.sh/v1
kind: ClusterAccountTemplate
metadata:
  name: my-cluster-account-template
spec:
  accountTemplate:
    spec:
      space:
        clusterRole: loft-cluster-space-default
  owns:
   - apiVersion: config.kiosk.sh/v1alpha1
     kind: AccountQuota
     # No metadata needed, generateName will be set automatically
     spec:
       account: '${LOFT_ACCOUNT_NAME}'
       quota:
         hard:
           limits.cpu: '8'
           limits.memory: '16Gi'
           requests.cpu: '2'
           requests.memory: '4Gi'
    - apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRoleBinding
      # No subjects needed, kiosk automatically syncs those based on the ownerReference
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: ClusterRole
        name: cluster-admin
```

Create the Cluster Account Template using `kubectl`:
```bash
# IMPORTANT: Run this command inside the loft management cluster
kubectl create -f clusteraccounttemplate.yaml
```

</TabItem>
</Tabs>

## Apply Account Templates to Users & Teams

Applying cluster account templates to an user or team can be done either via kubectl or the loft UI. For automatically applying account templates to users on single sign on, please see the next section.

<Tabs
  groupId="ui-cli-kubectl"
  defaultValue="ui"
  values={[
    { label: 'UI', value: 'ui', },
    { label: 'kubectl', value: 'kubectl', },
  ]
}>
<TabItem value="ui">

Navigate to the Users or Users -> Teams. Click either on Add or Edit User / Team. You will be presented with the following Drawer:

<figure class="frame">
  <img src="/docs/media/ui/auth/cat-apply.png" alt="Apply Cluster Account Templates" />
  <figcaption>Apply Cluster Account Templates</figcaption>
</figure>

In the Account Templates section you are able to select one or multiple cluster account templates to apply to a user or team.

:::tip Preselect Account Templates
Some account templates might be preselected, these are the templates that have the label `loft.sh/default-template: "true"` specified.
:::

:::note How Templates are applied
The account templates will be applied in the order that they are specified, if multiple account templates target the same cluster, only **ONE** account is created for the cluster and templates are skipped for a cluster if an account for that user or team does already exist.
If an error during applying the account templates is encountered, the error message can be viewed in the Status column of the user or team.
:::

:::note Reapply Templates
If you want to reapply a template for an user or team, delete it and then re-add it to the user or team. This will **NOT** delete accounts and only works for templates that have failed to apply.
If you want to delete a template and the corresponding account resources, please delete the account of the user in the cluster instead. This will delete **ALL** spaces and resources the account owns in the cluster.
:::

</TabItem>
<TabItem value="kubectl">

```bash
# Users
# IMPORTANT: Run this command inside the loft management cluster
kubectl edit user my-user

# Teams
# IMPORTANT: Run this command inside the loft management cluster
kubectl edit team my-team
```

Then change the user or team yaml according to this:

```yaml
apiVersion: storage.loft.sh/v1
kind: User
[...]
spec:
  [...]
  # The cluster account templates you want to apply
  clusterAccountTemplates:
    - name: loft-all-clusters-default
```

</TabItem>
</Tabs>

## Automatically Apply Account Templates on Single Sign On

A very useful feature of cluster account templates is that they can be applied automatically to new users that log in through an external identity provider for the first time.
Please make sure you have setup loft to use your [OIDC](./oidc.mdx) provider.

Cluster account templates can be applied to new users either always or based on what groups they are in. To configure what cluster account templates should be automatically applied, go to the Admin -> Config view in the loft UI.

<figure class="frame">
  <img src="/docs/media/ui/auth/cat-oidc.png" alt="Configure Automatic Cluster Account Templates" />
  <figcaption>Configure Automatic Cluster Account Templates</figcaption>
</figure>

In this view you can configure which cluster account templates are applied to the new users that sign in through OIDC for the first time. An example configuration could look like this:

```yaml
auth:
  oidc:
    issuerUrl: 'https://my.issuer.com/'
    clientId: CLIENT_ID
    clientSecret: CLIENT_SECRET
    groupsClaim: groups
    getUserInfo: true
    # Apply these templates based on which group
    # an user is in
    groupClusterAccountTemplates:
      # If the user is in the admin-group, add the loft-all-clusters-admin template
      admin-group:
        - name: loft-all-clusters-admin
    # Apply these templates always to new users
    clusterAccountTemplates:
    - name: loft-all-clusters-default
```

:::tip Order of Cluster Account Templates
Cluster account templates from groups (`auth.oidc.groupClusterAccountTemplates`) are added before the default cluster account templates (`auth.oidc.clusterAccountTemplates`), hence it is possible to always apply the default template and only if an user has the admin group the admin cluster template.
:::